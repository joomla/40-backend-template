if(!window.jQuery)throw new Error("WebInstaller plugin requires jQuery");if(!Joomla)throw new Error("Joomla API is not properly initialised");((e,t,i,l)=>{"use strict";const n={view:"dashboard",id:0,ordering:"",list:0,options:i.getOptions("plg_installer_webinstaller",{})};let s;class a{initialise(){if(n.loaded=1,t.getElementById("myTabContent")){const e=t.getElementById("web");t.getElementById("uploadform-web-cancel").addEventListener("click",()=>{t.getElementById("uploadform-web").classList.add("hidden"),n.list&&t.querySelector(".list-view")&&t.querySelector(".list-view").click()}),e.insertAdjacentHTML("afterbegin",'<div id="appsloading" class="ifw-loading-container"></div>'),e.style.position="absolute",l("#appsloading").on("ajaxStart",()=>{t.body.classList.add("ifw-busy"),t.getElementById("appsloading").classList.remove("hidden")}).on("ajaxStop",()=>{t.getElementById("appsloading").classList.add("hidden"),t.body.classList.remove("ifw-busy")})}this.loadweb(`${n.options.base_url}index.php?format=json&option=com_apps&view=dashboard`),this.clickforlinks()}loadweb(s){if(!s)return!1;const r=this,o=new RegExp(n.options.base_url),d=new RegExp("^index.php");if(!o.test(s)&&!d.test(s))return e.open(s,"_blank"),!1;let c=`${s}&product=${n.options.product}&release=${n.options.release}&dev_level=${n.options.dev_level}&list=${n.list?"list":"grid"}&lang=${n.options.language}`;if(""!==n.ordering&&t.getElementById("com-apps-ordering").value&&(n.ordering=t.getElementById("com-apps-ordering").value,c+=`&ordering=${n.ordering}`),t.getElementById("myTabContent")){const e=t.getElementById("appsloading");e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="100%",e.style.height="100%";const i=t.getElementById("web");i.style.position="relative",i.appendChild(e),l("#appsloading").trigger("ajaxStart")}return l.ajax({url:c,dataType:"jsonp",cache:!0,jsonpCallback:"jedapps_jsonpcallback",timeout:2e4,success(e){t.getElementById("web-loader")&&t.getElementById("web-loader").classList.add("hidden"),t.getElementById("jed-container").innerHTML=e.data.html,t.getElementById("com-apps-searchbox").addEventListener("keypress",e=>{13===e.which&&r.initiateSearch()}),t.getElementById("search-extensions").addEventListener("click",()=>{r.initiateSearch()}),t.getElementById("search-reset").addEventListener("click",()=>{t.getElementById("com-apps-searchbox").value="",r.initiateSearch()});const i=t.getElementById("com-apps-ordering");i&&i.addEventListener("change",()=>{const e=i.selectedIndex;n.ordering=i.options[e].value,r.installfromwebajaxsubmit()}),""!==n.options.installfrom_url&&r.installfromweb(n.options.installfrom_url)},fail(){t.getElementById("web-loader")&&(t.getElementById("web-loader").classList.add("hidden"),t.getElementById("web-loader-error").classList.remove("hidden"))},complete(){const s=t.getElementById("joomlaapsinstallatinput");if(s&&(s.value=n.options.installat_url),r.clickforlinks(),a.clicker(),"extension"!==n.view&&[].slice.call(t.querySelectorAll("div.load-extension")).forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),r.processLinkClick(e.getAttribute("data-url"))}),e.setAttribute("href","#")}),"extension"===n.view){const l=t.getElementById("install-extension"),n=t.getElementById("install-extension-from-external");l&&l.addEventListener("click",()=>{r.installfromweb(l.getAttribute("data-downloadurl"),l.getAttribute("data-name"))}),n&&n.addEventListener("click",()=>{const l=n.getAttribute("data-downloadurl");!0===e.confirm(i.JText._("PLG_INSTALLER_WEBINSTALLER_REDIRECT_TO_EXTERNAL_SITE_TO_INSTALL").replace("[SITEURL]",l))&&(t.getElementById("adminForm").setAttribute("action",l),t.querySelector("input[name=task]").setAttribute("disabled",!0),t.querySelector("input[name=install_directory]").setAttribute("disabled",!0),t.querySelector("input[name=install_url]").setAttribute("disabled",!0),t.querySelector("input[name=installtype]").setAttribute("disabled",!0),t.querySelector("input[name=filter_search]").setAttribute("disabled",!0),t.getElementById("adminForm").submit())})}n.list&&t.querySelector(".list-view")&&t.querySelector(".list-view").click(),t.getElementById("myTabContent")&&l("#appsloading").trigger("ajaxStop")},error(e){const i=t.getElementById("web-loader-error"),l=t.getElementById("web-loader");e.responseText&&i&&(i.innerHTML=e.responseText),l&&(l.classList.add("hidden"),i.classList.remove("hidden"))}}),!0}clickforlinks(){const e=this;[].slice.call(t.querySelectorAll("a.transcode")).forEach(t=>{const i=t.getAttribute("href");t.addEventListener("click",t=>{t.preventDefault(),e.processLinkClick(i)}),t.setAttribute("href","#")})}initiateSearch(){n.view="dashboard",this.installfromwebajaxsubmit()}installfromwebajaxsubmit(){let e=`&view=${n.view}`;if(n.id&&(e+=`&id=${n.id}`),t.getElementById("com-apps-searchbox").value){e+=`&filter_search=${encodeURI(t.getElementById("com-apps-searchbox").value.toLowerCase().replace(/ +/g,"_").replace(/[^a-z0-9-_]/g,"").trim())}`}""!==n.ordering&&t.getElementById("com-apps-ordering").value&&(n.ordering=t.getElementById("com-apps-ordering").value),n.ordering&&(e+=`&ordering=${n.ordering}`),this.loadweb(`${n.options.base_url}index.php?format=json&option=com_apps${e}`)}processLinkClick(e){const t=new RegExp(n.options.base_url),i=new RegExp("^index.php");t.test(e)||i.test(e)?(n.view=e.replace(/^.+[&?]view=(\w+).*$/,"$1"),"dashboard"===n.view?n.id=0:"category"===n.view&&(n.id=e.replace(/^.+[&?]id=(\d+).*$/,"$1")),this.loadweb(n.options.base_url+e)):this.loadweb(e)}static clicker(){t.querySelector(".grid-view")&&t.querySelector(".grid-view").addEventListener("click",()=>{n.list=0,t.querySelector(".list-container").classList.add("hidden"),t.querySelector(".grid-container").classList.remove("hidden"),t.getElementById("btn-list-view").classList.remove("active"),t.getElementById("btn-grid-view").classList.remove("active")}),t.querySelector(".list-view")&&t.querySelector(".list-view").addEventListener("click",()=>{n.list=1,t.querySelector(".grid-container").classList.add("hidden"),t.querySelector(".list-container").classList.remove("hidden"),t.getElementById("btn-grid-view").classList.remove("active"),t.getElementById("btn-list-view").classList.add("active")})}installfromweb(e,l){if(!e)return alert(i.JText._("PLG_INSTALLER_WEBINSTALLER_CANNOT_INSTALL_EXTENSION_IN_PLUGIN")),!1;const n=t.getElementById("install_url"),s=t.getElementById("uploadform-web-url");if(n.value=e,s.innerHTML=e,l){t.getElementById("uploadform-web-name").innerHTML=l,t.getElementById("uploadform-web-name-label").classList.remove("hidden")}else t.getElementById("uploadform-web-name-label").classList.add("hidden");return t.getElementById("uploadform-web").classList.remove("hidden"),!0}}l(e=>{const t=e("#myTabTabs").find('a[href="#web"]');n.options.installfromon&&t.click(),t.hasClass("active")&&(s||(s=new a).initialise()),t.closest("li").click(()=>{s||(s=new a).initialise()}),""!==n.options.installfrom_url&&t.closest("li").click(),t.on("shown.bs.tab",()=>{s||(s=new a).initialise()})})})(window,document,Joomla,window.jQuery);